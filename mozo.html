<!doctype html><html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mozo – Nuevo Pedido</title>
<meta name="theme-color" content="#1a1a1a">
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:0;background:#111;color:#eee;}
  .navbar{background:#1a1a1a;border-bottom:2px solid #333;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
  .navbar-brand{font-size:18px;font-weight:700;color:#10b981}
  .navbar-links{display:flex;gap:12px}
  .navbar-links a{color:#eee;text-decoration:none;padding:6px 12px;border-radius:6px;font-size:14px;transition:background 0.2s}
  .navbar-links a:hover{background:rgba(255,255,255,.1)}
  .navbar-links a.active{background:#10b981;color:#000}
  .content{padding:16px}
  .row{margin:12px 0}
  .card{border:1px solid #444;padding:12px;border-radius:10px;margin:8px 0;background:rgba(255,255,255,.04);}
  label{margin-right:12px;font-weight:500;}
  button{padding:10px 16px;border-radius:10px;border:1px solid #444;background:rgba(255,255,255,.08);color:#eee;cursor:pointer;font-size:15px;}
  button:hover{filter:brightness(1.15);}
  button:active{transform:scale(0.98);}
  textarea{background:#222;color:#eee;border-radius:8px;border:1px solid #444;padding:8px;width:100%;box-sizing:border-box;font-family:inherit;}
  select,input[type=text],input[type=search]{background:#222;color:#eee;border-radius:8px;border:1px solid #444;padding:8px;font-size:15px;}
  #statusBar{background:#10b981;color:#fff;padding:10px;text-align:center;font-weight:500;}
  #statusBar.offline{background:#ef4444;}
  .tabs{display:flex;gap:8px;margin:16px 0;border-bottom:2px solid #333;}
  .tab{padding:10px 16px;cursor:pointer;border-radius:8px 8px 0 0;background:transparent;border:none;color:#999;font-size:15px;}
  .tab.active{background:rgba(255,255,255,.08);color:#eee;font-weight:500;}
  .tab-content{display:none;}
  .tab-content.active{display:block;}
  .categories{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;}
  .cat-btn{padding:8px 14px;border-radius:20px;border:1px solid #555;background:#222;color:#aaa;font-size:14px;cursor:pointer;}
  .cat-btn.active{background:#3b82f6;color:#fff;border-color:#3b82f6;}
  .products{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));margin:12px 0;}
  .product{border:1px solid #444;border-radius:10px;padding:10px;text-align:center;cursor:pointer;background:#1a1a1a;transition:all 0.2s;}
  .product:hover{border-color:#3b82f6;background:#222;}
  .product:active{transform:scale(0.96);}
  .product-name{font-size:14px;margin-bottom:4px;font-weight:500;}
  .product-price{font-size:13px;color:#10b981;font-weight:600;}
  .search-box{width:100%;padding:10px;font-size:15px;margin-bottom:12px;}
  .cart{margin:16px 0;}
  .cart-item{border:1px solid #444;border-radius:8px;margin:8px 0;background:#1a1a1a;padding:10px;}
  .cart-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
  .cart-item-name{font-weight:600;font-size:16px;}
  .cart-item-qty{display:flex;gap:8px;align-items:center;}
  .cart-item-qty button{padding:6px 12px;font-size:14px;min-width:36px;}
  .cart-item-notes{width:100%;margin-top:6px;font-size:13px;padding:6px;background:#222;border:1px solid #444;border-radius:6px;color:#eee;}
  .modifiers-section{margin-top:8px;padding-top:8px;border-top:1px dashed #444;}
  .modifiers-label{font-size:13px;opacity:.7;margin-bottom:6px;}
  .modifier-chips{display:flex;flex-wrap:wrap;gap:6px;}
  .modifier-chip{padding:4px 10px;border-radius:12px;border:1px solid #555;background:#222;font-size:12px;cursor:pointer;transition:all 0.2s;}
  .modifier-chip:hover{border-color:#10b981;}
  .modifier-chip.active{background:#10b981;color:#fff;border-color:#10b981;}
  .total{font-size:18px;font-weight:600;color:#10b981;text-align:right;margin:12px 0;}
  .btn-primary{background:#3b82f6;border-color:#3b82f6;color:#fff;font-weight:600;font-size:16px;}
  .btn-primary:hover{background:#2563eb;}
  .toast{position:fixed;bottom:20px;right:20px;background:#10b981;color:#fff;padding:12px 20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:9999;animation:slideIn 0.3s ease;}
  .toast.error{background:#ef4444;}
  @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
</style>
</head><body>

<nav class="navbar">
  <div class="navbar-brand">Mozo</div>
  <div class="navbar-links">
    <a href="./mozo.html" class="active">Mozo</a>
    <a href="./cocina.html">Cocina</a>
    <a href="./admin.html">Admin</a>
  </div>
</nav>

<div id="statusBar">En línea</div>

<div class="content">
  <h2>Nuevo pedido</h2>

  <div class="row">
    <label>Mesa:
      <select id="mesa">
        <option value="1">Mesa 1</option>
        <option value="2">Mesa 2</option>
        <option value="3">Mesa 3</option>
        <option value="4">Mesa 4</option>
        <option value="5">Mesa 5</option>
        <option value="6">Mesa 6</option>
        <option value="7">Mesa 7</option>
        <option value="8">Mesa 8</option>
        <option value="9">Mesa 9</option>
        <option value="10">Mesa 10</option>
      </select>
    </label>
    <label>Mozo:
      <input id="mozo" type="text" placeholder="Tu nombre" value="">
    </label>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="menu">Menú</button>
    <button class="tab" data-tab="libre">Pedido Libre</button>
  </div>

  <div id="menu" class="tab-content active">
    <input type="search" id="searchProduct" class="search-box" placeholder="Buscar producto...">
    <div class="categories" id="categories"></div>
    <div class="products" id="products"></div>
  </div>

  <div id="libre" class="tab-content">
    <label>Pedido (texto libre):</label>
    <textarea id="pedidoLibre" rows="4" placeholder="Ej: 2 cafés, 1 medialuna, 1 tostado sin sal..."></textarea>
  </div>

  <div class="cart" id="cart" style="display:none">
    <h3>Carrito</h3>
    <div id="cartItems"></div>
    <div class="total" id="cartTotal">Total: $0</div>
  </div>

  <div class="row">
    <button class="btn btn-primary" id="enviarBtn" style="width:100%">Enviar pedido</button>
  </div>
</div>

<script>
const API = location.origin;
let categories = [];
let products = [];
let modifiers = [];
let cart = [];
let selectedCategory = null;
let isOnline = navigator.onLine;

// Persistencia del carrito
const CART_KEY = 'mozo_cart_v1';
const MOZO_KEY = 'mozo_nombre';

function saveCart() {
  localStorage.setItem(CART_KEY, JSON.stringify(cart));
}

function loadCart() {
  try {
    const saved = localStorage.getItem(CART_KEY);
    if (saved) {
      cart = JSON.parse(saved);
      renderCart();
    }
  } catch(e) {
    console.error('Error cargando carrito:', e);
  }
}

function saveMozoName() {
  const nombre = document.getElementById('mozo').value;
  if (nombre) {
    localStorage.setItem(MOZO_KEY, nombre);
  }
}

function loadMozoName() {
  const saved = localStorage.getItem(MOZO_KEY);
  if (saved) {
    document.getElementById('mozo').value = saved;
  }
}

// Monitorear conexión
function updateStatus() {
  isOnline = navigator.onLine;
  const bar = document.getElementById('statusBar');
  if (isOnline) {
    bar.textContent = 'En línea';
    bar.className = '';
  } else {
    bar.textContent = 'Sin conexión - Los pedidos se guardarán localmente';
    bar.className = 'offline';
  }
}

window.addEventListener('online', updateStatus);
window.addEventListener('offline', updateStatus);
updateStatus();

// Toast notifications
function showToast(msg, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// Tabs
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    document.getElementById(t.dataset.tab).classList.add('active');
  });
});

// Cargar datos
async function loadData(){
  try {
    const [catRes, prodRes, modRes] = await Promise.all([
      fetch(API + '/categories'),
      fetch(API + '/products'),
      fetch(API + '/modifiers')
    ]);
    categories = await catRes.json();
    products = await prodRes.json();
    modifiers = await modRes.json();
    renderCategories();
    renderProducts();
  } catch(e) {
    console.error('Error cargando datos:', e);
    showToast("Error cargando menú", "error");
  }
}

function renderCategories(){
  const el = document.getElementById('categories');
  el.innerHTML = `
    <button class="cat-btn ${!selectedCategory ? 'active' : ''}" data-cat="all">Todos</button>
    ${categories.map(c => `
      <button class="cat-btn ${selectedCategory === c.id ? 'active' : ''}" data-cat="${c.id}">${c.nombre}</button>
    `).join('')}
  `;
  el.querySelectorAll('.cat-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      selectedCategory = btn.dataset.cat === 'all' ? null : parseInt(btn.dataset.cat);
      renderCategories();
      renderProducts();
    });
  });
}

function renderProducts(){
  const search = document.getElementById('searchProduct').value.toLowerCase();
  let filtered = products;
  if (selectedCategory) {
    filtered = filtered.filter(p => p.category_id === selectedCategory);
  }
  if (search) {
    filtered = filtered.filter(p => p.nombre.toLowerCase().includes(search));
  }
  
  const el = document.getElementById('products');
  if (filtered.length === 0) {
    el.innerHTML = '<p style="text-align:center;opacity:0.6;padding:20px">No hay productos</p>';
    return;
  }
  
  el.innerHTML = filtered.map(p => `
    <div class="product" data-id="${p.id}">
      <div class="product-name">${p.nombre}</div>
      <div class="product-price">$${p.precio.toFixed(0)}</div>
    </div>
  `).join('');
  
  el.querySelectorAll('.product').forEach(prod => {
    prod.addEventListener('click', () => {
      const id = parseInt(prod.dataset.id);
      addToCart(id);
    });
  });
}

document.getElementById('searchProduct').addEventListener('input', renderProducts);

function addToCart(productId){
  const product = products.find(p => p.id === productId);
  if (!product) return;
  
  const existing = cart.find(c => c.id === productId && c.modifiers.length === 0);
  if (existing) {
    existing.cantidad++;
  } else {
    cart.push({
      id: productId,
      nombre: product.nombre,
      precio: product.precio,
      cantidad: 1,
      notas: '',
      modifiers: []
    });
  }
  saveCart();
  renderCart();
  showToast(`${product.nombre} agregado`, "success");
}

function renderCart(){
  const cartEl = document.getElementById('cart');
  const itemsEl = document.getElementById('cartItems');
  const totalEl = document.getElementById('cartTotal');
  
  if (cart.length === 0) {
    cartEl.style.display = 'none';
    return;
  }
  
  cartEl.style.display = 'block';
  
  let total = 0;
  itemsEl.innerHTML = cart.map((item, idx) => {
    const modTotal = item.modifiers.reduce((sum, m) => sum + (m.precio_extra || 0), 0);
    const itemTotal = (item.precio + modTotal) * item.cantidad;
    total += itemTotal;
    
    return `
      <div class="cart-item">
        <div class="cart-item-header">
          <div class="cart-item-name">${item.nombre}</div>
          <div class="cart-item-qty">
            <button data-idx="${idx}" data-action="minus">−</button>
            <span style="min-width:30px;text-align:center;font-weight:600">${item.cantidad}</span>
            <button data-idx="${idx}" data-action="plus">+</button>
            <button data-idx="${idx}" data-action="remove" style="background:#ef4444;border-color:#ef4444">🗑️</button>
          </div>
        </div>
        <div style="font-size:13px;color:#10b981;margin-bottom:6px">
          $${item.precio.toFixed(0)} c/u ${modTotal > 0 ? `+ $${modTotal.toFixed(0)} extras` : ''} = $${itemTotal.toFixed(0)}
        </div>
        <input type="text" class="cart-item-notes" placeholder="Notas (ej: sin azúcar)" 
               value="${item.notas}" data-idx="${idx}">
        <div class="modifiers-section">
          <div class="modifiers-label">Modificadores:</div>
          <div class="modifier-chips">
            ${modifiers.map(m => {
              const isActive = item.modifiers.some(im => im.modifier_id === m.id);
              return `
                <div class="modifier-chip ${isActive ? 'active' : ''}" 
                     data-idx="${idx}" data-mod-id="${m.id}">
                  ${m.nombre}${m.precio_extra > 0 ? ' +$' + m.precio_extra.toFixed(0) : ''}
                </div>
              `;
            }).join('')}
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  totalEl.textContent = `Total: $${total.toFixed(0)}`;
  
  // Botones cantidad
  itemsEl.querySelectorAll('button').forEach(btn => {
    const idx = parseInt(btn.dataset.idx);
    const action = btn.dataset.action;
    btn.addEventListener('click', () => {
      if (action === 'plus') cart[idx].cantidad++;
      if (action === 'minus' && cart[idx].cantidad > 1) cart[idx].cantidad--;
      if (action === 'remove') cart.splice(idx, 1);
      saveCart();
      renderCart();
    });
  });
  
  // Notas
  itemsEl.querySelectorAll('.cart-item-notes').forEach(input => {
    const idx = parseInt(input.dataset.idx);
    input.addEventListener('input', () => {
      cart[idx].notas = input.value;
      saveCart();
    });
  });
  
  // Modificadores
  itemsEl.querySelectorAll('.modifier-chip').forEach(chip => {
    const idx = parseInt(chip.dataset.idx);
    const modId = parseInt(chip.dataset.modId);
    
    chip.addEventListener('click', () => {
      const modifier = modifiers.find(m => m.id === modId);
      if (!modifier) return;
      
      const existingIdx = cart[idx].modifiers.findIndex(m => m.modifier_id === modId);
      
      if (existingIdx >= 0) {
        cart[idx].modifiers.splice(existingIdx, 1);
      } else {
        cart[idx].modifiers.push({
          modifier_id: modId,
          nombre: modifier.nombre,
          precio_extra: modifier.precio_extra
        });
      }
      saveCart();
      renderCart();
    });
  });
}

document.getElementById('enviarBtn').addEventListener('click', async () => {
  const mesa = parseInt(document.getElementById('mesa').value);
  const mozo = document.getElementById('mozo').value.trim();
  
  saveMozoName();
  
  const activeTab = document.querySelector('.tab.active').dataset.tab;
  
  let payload;
  
  if (activeTab === 'menu') {
    if (cart.length === 0) {
      return showToast('El carrito está vacío', 'error');
    }
    payload = {
      table_id: mesa,
      user_name: mozo || null,
      items: cart.map(c => ({
        product_id: c.id,
        cantidad: c.cantidad,
        notas: c.notas || null,
        modifiers: c.modifiers.map(m => ({
          modifier_id: m.modifier_id,
          nombre: m.nombre
        }))
      }))
    };
  } else {
    const libre = document.getElementById('pedidoLibre').value.trim();
    if (!libre) {
      return showToast('Escribí el pedido', 'error');
    }
    payload = {
      table_id: mesa,
      user_name: mozo || null,
      items: [{
        product_id: null,
        cantidad: 1,
        notas: libre,
        modifiers: []
      }]
    };
  }
  
  try {
    const res = await fetch(API + "/orders", {
      method: "POST",
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    
    if (!res.ok) throw new Error('Error en el servidor');
    
    const js = await res.json();
    if (js.ok) {
      showToast(`✅ Pedido enviado #${js.order_id}`, "success");
      cart = [];
      document.getElementById('pedidoLibre').value = '';
      localStorage.removeItem(CART_KEY);
      renderCart();
    } else {
      throw new Error("respuesta no OK");
    }
  } catch(err) {
    console.error('Error enviando pedido:', err);
    showToast("❌ Error al enviar pedido. Verifica la conexión.", "error");
  }
});

// Cargar datos iniciales
loadData();
loadCart();
loadMozoName();
</script>
</body></html>