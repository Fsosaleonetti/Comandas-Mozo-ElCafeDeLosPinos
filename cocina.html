<!doctype html><html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cocina ‚Äì Comandas</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:0;background:#111;color:#eee;}
  .navbar{background:#1a1a1a;border-bottom:2px solid #333;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
  .navbar-brand{font-size:18px;font-weight:700;color:#10b981}
  .navbar-links{display:flex;gap:12px}
  .navbar-links a{color:#eee;text-decoration:none;padding:6px 12px;border-radius:6px;font-size:14px;transition:background 0.2s}
  .navbar-links a:hover{background:rgba(255,255,255,.1)}
  .navbar-links a.active{background:#10b981;color:#000}
  .content{padding:16px}
  .layout{display:grid;grid-template-columns:1fr 300px;gap:20px;}
  @media(max-width:1024px){.layout{grid-template-columns:1fr;}}
  
  #lista{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));align-items:start;}
  .card{background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.15);border-radius:14px;padding:12px;transition:all 0.3s;}
  .card.anulada{opacity:.65;filter:grayscale(.15);}
  .card.pendiente{border-color:#10b981;}
  .card.listo{border-color:#f59e0b;}
  .card.cobrado{border-color:#3b82f6;}
  
  .badge{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:2px 8px;margin-right:6px;font-size:13px;}
  .badge-estado{font-weight:600;padding:4px 10px;}
  .badge-estado.pendiente{background:#10b981;color:#000;}
  .badge-estado.listo{background:#f59e0b;color:#000;}
  .badge-estado.cobrado{background:#3b82f6;color:#fff;}
  
  .btn{padding:7px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:transparent;cursor:pointer;font-size:14px;color:#eee}
  .btn:hover{filter:brightness(1.1);}
  .muted{font-size:12px;opacity:.7;}
  .totales{margin-top:10px;padding:10px;background:rgba(255,255,255,.03);border-radius:8px;}
  .total-row{display:flex;justify-content:space-between;margin:4px 0;}
  .total-row.final{font-size:18px;font-weight:700;color:#10b981;border-top:1px solid #444;padding-top:8px;margin-top:8px;}
  
  .sidebar{position:sticky;top:80px;}
  .sidebar-section{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.15);border-radius:14px;padding:16px;margin-bottom:16px;}
  .sidebar-section h3{margin:0 0 12px 0;font-size:18px;}
  
  .calculator{display:grid;gap:8px;}
  .calc-display{background:#222;border:1px solid #444;border-radius:8px;padding:12px;text-align:right;font-size:24px;font-weight:600;min-height:40px;user-select:none;}
  .calc-buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
  .calc-btn{padding:16px;border-radius:10px;border:1px solid #444;background:#1a1a1a;color:#eee;font-size:18px;cursor:pointer;font-weight:500;user-select:none;touch-action:manipulation;}
  .calc-btn:hover{background:#2a2a2a;}
  .calc-btn:active{transform:scale(0.95);background:#333;}
  .calc-btn.operator{background:#3b82f6;border-color:#3b82f6;color:#fff;}
  .calc-btn.equal{background:#10b981;border-color:#10b981;color:#fff;grid-column:span 2;}
  .calc-btn.clear{background:#ef4444;border-color:#ef4444;color:#fff;}
  .calc-history{margin-top:12px;max-height:200px;overflow-y:auto;}
  .calc-history-item{padding:8px;background:#1a1a1a;border-radius:6px;margin:4px 0;font-size:13px;}
  
  .toast{position:fixed;bottom:20px;right:20px;background:#10b981;color:#fff;padding:12px 20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:10000;animation:slideIn 0.3s ease;}
  .toast.error{background:#ef4444;}
  @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
  
  select,input,textarea{font-family:inherit;}
</style>
</head><body>

<nav class="navbar">
  <div class="navbar-brand">Cocina</div>
  <div class="navbar-links">
    <a href="./mozo.html">Mozo</a>
    <a href="./cocina.html" class="active">Cocina</a>
    <a href="./admin.html">Admin</a>
  </div>
</nav>

<div class="content">
  <h2>Comandas en Cocina</h2>
  <div style="display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap">
    <button id="refrescar" class="btn">üîÑ Refrescar</button>
    <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="verAnuladas"> Ver anuladas</label>
    <select id="filtroEstado" style="background:#222;border:1px solid #444;border-radius:8px;padding:6px 10px;color:#eee">
      <option value="">Todos los estados</option>
      <option value="pendiente">Pendientes</option>
      <option value="listo">Listos</option>
      <option value="cobrado">Cobrados</option>
    </select>
    <span id="status" class="muted"></span>
  </div>

  <div class="layout">
    <div>
      <div id="lista"></div>
    </div>
    
    <div class="sidebar">
      <div class="sidebar-section">
        <h3>üßÆ Calculadora</h3>
        <div class="calculator">
          <div class="calc-display" id="calcDisplay">0</div>
          <div class="calc-buttons" id="calcButtons">
            <button class="calc-btn" data-num="7">7</button>
            <button class="calc-btn" data-num="8">8</button>
            <button class="calc-btn" data-num="9">9</button>
            <button class="calc-btn operator" data-op="/">√∑</button>
            
            <button class="calc-btn" data-num="4">4</button>
            <button class="calc-btn" data-num="5">5</button>
            <button class="calc-btn" data-num="6">6</button>
            <button class="calc-btn operator" data-op="*">√ó</button>
            
            <button class="calc-btn" data-num="1">1</button>
            <button class="calc-btn" data-num="2">2</button>
            <button class="calc-btn" data-num="3">3</button>
            <button class="calc-btn operator" data-op="-">‚àí</button>
            
            <button class="calc-btn" data-num="0">0</button>
            <button class="calc-btn" data-num=".">.</button>
            <button class="calc-btn clear" data-action="clear">C</button>
            <button class="calc-btn operator" data-op="+">+</button>
            
            <button class="calc-btn equal" data-action="equals">=</button>
            <button class="calc-btn" data-action="back">‚å´</button>
            <button class="calc-btn" data-action="clearHistory">üóëÔ∏è</button>
          </div>
          <div class="calc-history" id="calcHistory"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API = location.origin;
const listaEl = document.getElementById("lista");
const refrescar = document.getElementById("refrescar");
const status = document.getElementById("status");
const verAnuladas = document.getElementById("verAnuladas");
const filtroEstado = document.getElementById("filtroEstado");
const WS_URL = (location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + location.host + '/ws/kitchen';

// Toast
function showToast(msg, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// CALCULADORA MEJORADA
let calcCurrent = '0';
let calcPrevious = '';
let calcOperation = null;
let calcHistory = JSON.parse(localStorage.getItem('calc_history') || '[]');

const calcDisplay = document.getElementById('calcDisplay');
const calcHistoryEl = document.getElementById('calcHistory');

function updateCalcDisplay(){
  calcDisplay.textContent = calcCurrent;
}

function addToHistory(entry){
  calcHistory.push(entry);
  if (calcHistory.length > 50) calcHistory.shift();
  localStorage.setItem('calc_history', JSON.stringify(calcHistory));
  renderCalcHistory();
}

function renderCalcHistory(){
  calcHistoryEl.innerHTML = calcHistory.slice(-10).reverse().map(h => 
    `<div class="calc-history-item">${h}</div>`
  ).join('');
}

// Eventos de botones de calculadora
document.getElementById('calcButtons').addEventListener('click', (e) => {
  const btn = e.target.closest('.calc-btn');
  if (!btn) return;
  
  e.preventDefault();
  e.stopPropagation();
  
  // N√∫meros
  if (btn.dataset.num !== undefined) {
    const num = btn.dataset.num;
    if (calcCurrent === '0' && num !== '.') {
      calcCurrent = num;
    } else if (num === '.' && calcCurrent.includes('.')) {
      return;
    } else {
      calcCurrent += num;
    }
    updateCalcDisplay();
    return;
  }
  
  // Operadores
  if (btn.dataset.op !== undefined) {
    if (calcOperation && calcPrevious) {
      calculate();
    }
    calcOperation = btn.dataset.op;
    calcPrevious = calcCurrent;
    calcCurrent = '0';
    return;
  }
  
  // Acciones
  const action = btn.dataset.action;
  if (action === 'equals') {
    calculate();
  } else if (action === 'clear') {
    calcCurrent = '0';
    calcPrevious = '';
    calcOperation = null;
    updateCalcDisplay();
  } else if (action === 'back') {
    if (calcCurrent.length > 1) {
      calcCurrent = calcCurrent.slice(0, -1);
    } else {
      calcCurrent = '0';
    }
    updateCalcDisplay();
  } else if (action === 'clearHistory') {
    calcHistory = [];
    localStorage.removeItem('calc_history');
    renderCalcHistory();
  }
});

function calculate(){
  if (!calcOperation || !calcPrevious) return;
  const a = parseFloat(calcPrevious);
  const b = parseFloat(calcCurrent);
  let result;
  
  switch(calcOperation){
    case '+': result = a + b; break;
    case '-': result = a - b; break;
    case '*': result = a * b; break;
    case '/': result = b !== 0 ? a / b : 'Error'; break;
  }
  
  if (result !== 'Error') {
    const opSymbol = {'+':'+', '-':'‚àí', '*':'√ó', '/':'√∑'}[calcOperation];
    addToHistory(`${a} ${opSymbol} ${b} = ${result}`);
    calcCurrent = result.toString();
  } else {
    calcCurrent = '0';
  }
  
  calcPrevious = '';
  calcOperation = null;
  updateCalcDisplay();
}

// SOPORTE TECLADO
document.addEventListener('keydown', (e) => {
  // Solo si no est√° en un input
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
    return;
  }
  
  const key = e.key;
  
  // N√∫meros
  if (key >= '0' && key <= '9') {
    if (calcCurrent === '0') {
      calcCurrent = key;
    } else {
      calcCurrent += key;
    }
    updateCalcDisplay();
    e.preventDefault();
  }
  
  // Punto
  if ((key === '.' || key === ',') && !calcCurrent.includes('.')) {
    calcCurrent += '.';
    updateCalcDisplay();
    e.preventDefault();
  }
  
  // Operadores
  if (['+', '-', '*', '/'].includes(key)) {
    if (calcOperation && calcPrevious) {
      calculate();
    }
    calcOperation = key;
    calcPrevious = calcCurrent;
    calcCurrent = '0';
    e.preventDefault();
  }
  
  // Enter o =
  if (key === 'Enter' || key === '=') {
    calculate();
    e.preventDefault();
  }
  
  // Escape o C
  if (key === 'Escape' || key === 'c' || key === 'C') {
    calcCurrent = '0';
    calcPrevious = '';
    calcOperation = null;
    updateCalcDisplay();
    e.preventDefault();
  }
  
  // Backspace
  if (key === 'Backspace') {
    if (calcCurrent.length > 1) {
      calcCurrent = calcCurrent.slice(0, -1);
    } else {
      calcCurrent = '0';
    }
    updateCalcDisplay();
    e.preventDefault();
  }
});

// Comandas
async function cargar(){
  const anuladas = verAnuladas && verAnuladas.checked ? 1 : 0;
  const estado = filtroEstado.value;
  let url = `${API}/orders?anuladas=${anuladas}`;
  if (estado) url += `&estado=${estado}`;
  
  const res = await fetch(url);
  const data = await res.json();
  render(data);
}

function render(lista){
  listaEl.innerHTML = lista.map(o=>{
    const estadoClass = o.anulada ? '' : o.estado;
    return `
    <div class="card ${o.anulada ? 'anulada' : estadoClass}" data-oid="${o.id}">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <span class="badge">${o.mesa||('Mesa '+o.table_id)}</span>
          <span class="badge-estado ${o.estado}">${o.estado.toUpperCase()}</span>
        </div>
        <span class="muted">${new Date(o.ts).toLocaleTimeString()}</span>
      </div>
      <div style="margin:8px 0">
        ${o.items.map(it=>`
          <div style="padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.1)">
            <strong>${it.cantidad}x ${it.nombre}</strong> 
            ${it.precio ? '<span style="color:#10b981">$'+it.precio.toFixed(0)+'</span>' : ''}
            ${it.modifiers && it.modifiers.length > 0 ? `
              <div style="font-size:12px;opacity:.7;padding-left:8px">+ ${it.modifiers.map(m => m.modifier_nombre).join(', ')}</div>
            ` : ''}
            ${it.notas ? '<div style="font-size:12px;opacity:.8;padding-left:8px;font-style:italic">'+it.notas+'</div>' : ''}
          </div>
        `).join("")}
      </div>
      <div class="totales">
        <div class="total-row"><span>Subtotal:</span><span>${(o.subtotal || 0).toFixed(0)}</span></div>
        ${o.descuento_total > 0 ? `<div class="total-row" style="color:#f59e0b"><span>Descuentos:</span><span>-${o.descuento_total.toFixed(0)}</span></div>` : ''}
        <div class="total-row final"><span>TOTAL:</span><span>${(o.total || 0).toFixed(0)}</span></div>
        ${o.pagado ? '<div style="color:#10b981;text-align:center;margin-top:8px;font-weight:600">‚úÖ PAGADO</div>' : ''}
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        ${o.anulada ? '' : `
          <select class="cambiarEstado" data-oid="${o.id}" style="background:#222;border:1px solid #444;border-radius:8px;padding:6px;color:#eee">
            <option value="pendiente" ${o.estado==='pendiente'?'selected':''}>Pendiente</option>
            <option value="listo" ${o.estado==='listo'?'selected':''}>Listo</option>
            <option value="cobrado" ${o.estado==='cobrado'?'selected':''}>Cobrado</option>
          </select>
        `}
        <span class="muted">${o.mozo || ''}</span>
      </div>
    </div>`
  }).join("");
  
  // Cambiar estado
  listaEl.querySelectorAll('.cambiarEstado').forEach(sel => {
    sel.addEventListener('change', async (e) => {
      const oid = e.target.dataset.oid;
      const estado = e.target.value;
      try {
        await fetch(`${API}/orders/${oid}/estado`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({estado})
        });
        showToast(`Estado cambiado a ${estado}`);
        cargar();
      } catch(err) {
        showToast('Error al cambiar estado', 'error');
      }
    });
  });
}

refrescar && (refrescar.onclick=cargar);
verAnuladas && (verAnuladas.onchange=cargar);
filtroEstado && (filtroEstado.onchange=cargar);
cargar();
renderCalcHistory();
updateCalcDisplay();

const ws = new WebSocket(WS_URL);
ws.onopen=()=>status.textContent="(escuchando pedidos...)";
ws.onclose=()=>status.textContent="(desconectado)";
ws.onmessage=(e)=>{ 
  const msg=JSON.parse(e.data); 
  if(['new_order','order_restored','order_updated','order_cancelled','discount_applied','payment_added'].includes(msg.type)){ 
    cargar(); 
  }
};
</script>
</body></html>